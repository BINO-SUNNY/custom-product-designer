{% extends "usernav.html" %}
{% load custom_filters %}
{% load static %}
{% block content %}
{% block stylecontent %}
<link href="{% static 'indexstyle/css/style.css' %}" rel="stylesheet">

<style>

    /* Global Styling */
    {% comment %} body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(to bottom, #e3f2fd, #bbdefb);
        color: #333;
        margin: 0;
        padding: 0;
    }
     {% endcomment %}
    /* Container Layout */
    .container1 {
        display: flex;
        align-items: flex-start;
        gap: 20px;
        padding-top: 120px;
        padding-left: 20px;
        padding-right: 20px;
        max-width: 1200px;
        margin: auto;
    }
    
    /* Left Panel - Sidebar */
    .left-panel {
        width: 280px;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(14px);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease-in-out;
    }
    
    /* Sidebar Navigation */
    .left-panel .nav-item1 {
        display: block;
        width: 100%;
        min-width: 180px;  /* Ensures same width */
        min-height: 50px;  /* Ensures same height */
        padding: 12px;
        background: transparent;
        color: black;
        margin-top: 15px;
        text-align: center;
        font-weight: bold;
        border: 2px solid black;
        border-radius: 25px;
        transition: background 0.3s, transform 0.3s;
        cursor: pointer;
        letter-spacing: 1px;
        box-sizing: border-box; /* Prevents width/height shrinking */

        
    }
    
    /* Hover Effect - Consistent Sizing */
    .left-panel .nav-item:hover {
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        transform: scale(1.05); /* Reduced scale to prevent size jump */
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .nav-item1.active {
        background: linear-gradient(135deg, #0056b3, #003d82);
        color: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        transform: scale(1.05);
    }
    
    /* Prevent Shrinking on Click */
    .left-panel .nav-item:active {
        transform: scale(1); /* Ensures button does not shrink */
    }
    
    /* Right Panel */
    .right-panel {
        flex-grow: 1;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    /* Tabs */
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    /* Template Container */
    .template-container {
        display: flex;
        flex-wrap: wrap;
        gap: 40px;
        justify-content: center;
    }
    
    /* Template Card */
    .template-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(15px);
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        padding: 20px;
        width: 270px;
        text-align: center;
        transition: transform 0.4s, box-shadow 0.4s;
        position: relative;
    }
    
    .template-card:hover {
        transform: scale(1.08);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
    }
    
    /* Template Image */
    .template-img {
        width: 100%;
        height: 170px;
        object-fit: cover;
        border-radius: 10px;
        margin-bottom: 12px;
    }
    
    /* Star Rating */
    .star-rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: center;
    }
    
    .star-rating input {
        display: none;
    }
    
    .star-rating label {
        font-size: 26px;
        color: #ddd;
        cursor: pointer;
        transition: color 0.3s ease-in-out;
    }
    
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
        color: gold;
    }
    
    /* Forms */
    form label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #333;
    }
    
    form input {
        width: 100%;
        padding: 12px;
        margin-bottom: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        transition: border 0.3s;
    }
    
    form input:focus {
        border-color: #007bff;
        box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
        outline: none;
    }
    
    /* Buttons */
    form button {
        padding: 12px 20px;
        background: linear-gradient(135deg, #007bff, #0056b3);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        letter-spacing: 1px;
        transition: background 0.3s ease-in-out, transform 0.2s;
    }
    
    form button:hover {
        background: linear-gradient(135deg, #0056b3, #003d80);
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    /* Responsive Design */
    @media (max-width: 768px) {
        .container1 {
            flex-direction: column;
            align-items: center;
        }
    
        .left-panel {
            width: 100%;
            text-align: center;
        }
    
        .right-panel {
            width: 100%;
        }
    
        .template-card {
            width: 90%;
        }
    }

    .delete-btn {
        background-color: #e74c3c;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .delete-btn:hover {
        background-color: #c0392b;
    }
    
    .show-users-btn {
        background-color: #3498db;
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    .show-users-btn:hover {
        background-color: #2980b9;
    }
    
    

</style>
<script>
function activateTab(selectedTab) {
    // Remove "active" class from all buttons
    document.querySelectorAll('.nav-item1').forEach(item => {
        item.classList.remove('active');
    });

    // Add "active" class to the clicked button
    selectedTab.classList.add('active');
}
</script>


    
{% endblock %}



<div class="container1">
    <!-- Left Panel (Tabs) -->
    <div class="left-panel">
        <ul class="nav">
            <li class="nav-item1 active" id="editProfileTab" onclick="activateTab(this)">Edit Profile</li><br>
            <li class="nav-item1" id="changePasswordTab" onclick="activateTab(this)">Change Password</li><br>
            <li class="nav-item1" id="myOrdersTab" onclick="activateTab(this)">My Orders</li><br>
            <li class="nav-item1" id="myTemplatesTab" onclick="activateTab(this)">My Templates</li>
        </ul>
    </div>
    

    <!-- Right Panel (Content Area) -->
    <div class="right-panel">
        <div id="editProfile" class="tab-content">
            <h3>Edit Profile</h3>
            <form id="editProfileForm">
                <label for="email">Email:</label>
                <input type="email" id="email" value="{{ login_details.email }}" name="email" disabled><br>
        
                <label for="name">Name:</label>
                <input type="text" id="name" value="{{ user_details.name }}" name="name"><br>
        
                <label for="phno">Phone Number:</label>
                <input type="text" id="phno" value="{{user_details.phno }}" name="phno"><br>
        
                <button type="submit">Save Changes</button>
                <p id="profileMessage"></p>
            </form>
        </div>
        
        <div id="changePassword" class="tab-content">
            <h3>Change Password</h3>
            <form id="changePasswordForm">
                <label for="currentPassword">Current Password:</label>
                <input type="password" id="currentPassword" name="currentPassword"><br>
        
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" name="newPassword"><br>
        
                <label for="confirmPassword">Confirm New Password:</label>
                <input type="password" id="confirmPassword" name="confirmPassword"><br>
        
                <button type="submit">Change Password</button>
                <p id="passwordMessage"></p>
            </form>
        </div>
        

        <div id="myOrders" class="tab-content">
            <h3>My Orders</h3>
            <div class="row">
                {% for order in my_orders %}
                    <div class="col-md-4">
                        <div class="card shadow-lg border-0 rounded-lg">
                            <div class="card-body">
                                {% comment %} <h5 class="card-title">Order ID: <strong>#{{ order.id }}</strong></h5> {% endcomment %}
                                <p class="card-text"><strong>Product:</strong> {{ order.product }}</p>
                                
                                <p class="card-text"><strong>Status:</strong> 
                                    <span class="badge 
                                        {% if order.status == 'Pending' %}bg-warning
                                        {% elif order.status == 'Approved' %}bg-success
                                        {% elif order.status == 'Rejected' %}bg-danger
                                        {% elif order.status == 'Delivered' %}bg-primary
                                        {% elif order.status == 'On Process' %}bg-info
                                        {% else %}bg-secondary{% endif %}">
                                        {{ order.status }}
                                    </span>
                                </p>
        
                                <p class="card-text"><strong>Request Date:</strong> {{ order.request_date }}</p>
        
                                {% with notifications|get_item:order.id as notification %}
                                    {% if notification and notification.design_request.id == order.id %}
                                        <p class="card-text"><strong>Expected Delivery:</strong> {{ notification.expected_date }}</p>
                                        <p class="card-text"><strong>Amount Payable:</strong> ${{ notification.amount }}</p>
                                    {% endif %}
                                {% endwith %}
        
                                {% if order.image %}
                                    <img src="{{ order.image.url }}" class="img-fluid rounded mt-2" alt="Order Image">
                                {% endif %}
        
                                <!-- Cancel Order Button -->
                                {% if order.status == 'Pending' or order.status == 'On Process' %}
                                    <button class="btn btn-danger mt-2 cancel-order w-100" data-order-id="{{ order.id }}">
                                        ❌ Cancel Order
                                    </button>
                                {% endif %}
        
                                <!-- Payment Section -->
                                {% if order.status == "On Process" %}
                                    <button class="btn btn-success mt-2 w-100 pay-now-btn" data-order-id="{{ order.id }}">
                                        💳 Pay Now
                                    </button>
        
                                    <div class="qr-payment mt-3 text-center" id="qr-payment-{{ order.id }}" style="display: none;">
                                        <img src="{% url 'generate_qr' order.id %}" alt="QR Code" class="img-fluid rounded" width="150">
                                        <button class="btn btn-primary mt-2 complete-payment-btn" data-order-id="{{ order.id }}">
                                            ✅ Complete Payment
                                        </button>
                                    </div>
                                {% endif %}
        
                                <!-- Review Section -->
                                {% if order.status == 'Delivered' and not order.review %}
                                    <button class="btn btn-info mt-2 w-100 review-btn" data-order-id="{{ order.id }}">
                                        ⭐ Leave a Review
                                    </button>
                                    <form class="review-form mt-3" id="review-form-{{ order.id }}" style="display: none;" data-order-id="{{ order.id }}">
                                        {% csrf_token %}
                                        <h6>Rate your experience:</h6>
                                        <div class="star-rating" data-order-id="{{ order.id }}">
                                            <input type="radio" id="star5-{{ order.id }}" name="rating-{{ order.id }}" value="5">
                                            <label for="star5-{{ order.id }}">★</label>
                                        
                                            <input type="radio" id="star4-{{ order.id }}" name="rating-{{ order.id }}" value="4">
                                            <label for="star4-{{ order.id }}">★</label>
                                        
                                            <input type="radio" id="star3-{{ order.id }}" name="rating-{{ order.id }}" value="3">
                                            <label for="star3-{{ order.id }}">★</label>
                                        
                                            <input type="radio" id="star2-{{ order.id }}" name="rating-{{ order.id }}" value="2">
                                            <label for="star2-{{ order.id }}">★</label>
                                        
                                            <input type="radio" id="star1-{{ order.id }}" name="rating-{{ order.id }}" value="1">
                                            <label for="star1-{{ order.id }}">★</label>
                                        </div>
                                        
                                        <textarea name="review_text" class="form-control mt-2" rows="3" placeholder="Write your review here..." required></textarea>
                                        <button type="submit" class="btn btn-primary mt-2">Submit Review</button>
                                    </form>
                                    
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <p>No orders found.</p>
                {% endfor %}
            </div>
        </div>
        
        

        <div id="myTemplates" class="tab-content">
            <h3>My Templates</h3>
            <div class="template-container">
                {% for template in my_templates %}
                    <div class="template-card">
                        <img src="{{ template.image.url }}" alt="Template Image" class="template-img">
                        <p><strong>Template ID:</strong> {{ template.id }}</p>
        
                        <!-- Show Users Button -->
                        <button class="show-users-btn" data-template-id="{{ template.id }}">
                            Show Users
                        </button>
        
                        <!-- Delete Template Button -->
                        <button onclick="deleteTemplate({{ template.id }})" class="delete-btn">Delete</button>
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">


        
                        <!-- Used By Section -->
                        <div class="used-by-container" id="used-by-{{ template.id }}" style="display: none;">
                            <h5>Used By:</h5>
                            <ul>
                                {% for used in template.used_by.all %}
                                    <li>{{ used.request.customer.username }} - Order ID: {{ used.request.id }}</li>
                                {% empty %}
                                    <p>No users have used this template.</p>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                {% empty %}
                    <p>No templates found.</p>
                {% endfor %}
            </div>
        </div>
        

<script>
 

        // Handle review form submission
  
        // Function to get CSRF token
  
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".review-form").forEach(form => {
                form.addEventListener("submit", async function (event) {
                    event.preventDefault();
        
                    let formData = new FormData(this);
                    let orderId = this.getAttribute("data-order-id");
                    let csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
                    
                    // Ensure a rating is selected
                    let ratingInput = this.querySelector(`input[name='rating-${orderId}']:checked`);

                    if (!ratingInput) {
                        alert("Please select a rating before submitting.");
                        return;
                    }
                    formData.append("rating", ratingInput.value);
        
                    try {
                        let response = await fetch(`/submit_review/${orderId}/`, {
                            method: "POST",
                            body: formData,
                            headers: { "X-CSRFToken": csrfToken }
                        });
        
                        let data = await response.json();
        
                        if (data.success) {
                            alert("Review submitted successfully!");
                            location.reload(); // Refresh page to show the review
                        } else {
                            alert(data.message);
                        }
                    } catch (error) {
                        console.error("Error submitting review:", error);
                        alert("Something went wrong. Please try again.");
                    }
                });
            });
        
            // Show review form when "Leave a Review" is clicked
     
        });
        
        
    document.addEventListener("DOMContentLoaded", function() {
     
        document.querySelectorAll(".pay-now-btn").forEach(button => {
            button.addEventListener("click", function () {
                let orderId = this.getAttribute("data-order-id");
                let qrDiv = document.getElementById("qr-payment-" + orderId);
                qrDiv.style.display = "block"; // Show QR Code section
            });
        });
    
        // Complete Payment & Update Status
        document.querySelectorAll(".complete-payment-btn").forEach(button => {
            button.addEventListener("click", function () {
                let orderId = this.getAttribute("data-order-id");
                fetch(`/update_payment_status/${orderId}/`, {
                    method: "POST",
                    headers: { "X-CSRFToken": getCSRFToken() }, // CSRF token function
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Payment Successful! Order status updated.");
                        location.reload(); // Refresh to show updated status
                    } else {
                        alert("Payment failed. Please try again.");
                    }
                });
            });
        });
        document.getElementById("editProfileForm").addEventListener("submit", function(event) {
            event.preventDefault();
            
            let formData = new FormData(this);
            
            fetch("/update-profile/", {
                method: "POST",
                body: formData,
                headers: {
                    "X-CSRFToken": getCSRFToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("profileMessage").innerText = data.message;
            })
            .catch(error => console.error("Error updating profile:", error));
        });
    
        // Handle password change
document.getElementById("changePasswordForm").addEventListener("submit", function(event) {
    event.preventDefault();
    
    let formData = new FormData(this);
    
    fetch("/change-password/", {
        method: "POST",
        body: formData,
        headers: {
            "X-CSRFToken": getCSRFToken()  // Get token from cookies
        }
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById("passwordMessage").innerText = data.message;
        if (data.success && data.redirect) {
            setTimeout(() => {
                alert("password updated please login.");

                window.location.href = data.redirect;
            }, 2000);
        }
    })
    .catch(error => console.error("Error changing password:", error));
});

// Function to get CSRF token from cookies
function getCSRFToken() {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(cookie => {
            let [name, value] = cookie.trim().split('=');
            if (name === "csrftoken") {
                cookieValue = decodeURIComponent(value);
            }
        });
    }
    return cookieValue;
}

        document.querySelectorAll(".show-users-btn").forEach(button => {
            button.addEventListener("click", function() {
                let templateId = this.getAttribute("data-template-id");
                let usedByDiv = document.getElementById("used-by-" + templateId);
    
                // If the section is already visible, just toggle it
                if (usedByDiv.style.display === "block") {
                    usedByDiv.style.display = "none";
                    return;
                }
    
                // Fetch users dynamically
                fetch(`/fetch_users_for_template/${templateId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.users && data.users.length > 0) {
                            let userListHTML = "<ul>";
                            data.users.forEach(user => {
                                userListHTML += `<li>${user.username} - Order ID: ${user.order_id}</li>`;
                            });
                            userListHTML += "</ul>";
                            usedByDiv.innerHTML = userListHTML;
                        } else {
                            usedByDiv.innerHTML = "<p>No users have used this template.</p>";
                        }
                        usedByDiv.style.display = "block";
                    })
                    .catch(error => console.error("Error fetching users:", error));
            });
        });
        // Show review form when "Leave a Review" is clicked
        document.querySelectorAll(".review-btn").forEach(button => {
            button.addEventListener("click", function() {
                let orderId = this.getAttribute("data-order-id");
                document.getElementById("review-form-" + orderId).style.display = "block";
                this.style.display = "none"; // Hide the button
            });
        });
    
        // Handle star rating click event
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll(".star-rating").forEach(starRating => {
                starRating.addEventListener("change", function (event) {
                    let selectedInput = event.target;
                    let allLabels = this.querySelectorAll("label");
        
                    // Reset all stars
                    allLabels.forEach(label => label.style.color = "#ccc");
        
                    // Highlight selected and previous stars
                    let prev = selectedInput.nextElementSibling;
                    while (prev) {
                        if (prev.tagName === "LABEL") prev.style.color = "gold";
                        prev = prev.nextElementSibling;
                    }
                });
            });
        });
        
        // Handle order cancellation
        document.querySelectorAll(".cancel-order").forEach(button => {
            button.addEventListener("click", function() {
                let orderId = this.getAttribute("data-order-id");
    
                fetch(`/cancel_order/${orderId}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "Content-Type": "application/json"
                    }
                }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("Order Cancelled Successfully!");
                        location.reload();
                    } else {
                        alert("Failed to Cancel Order.");
                    }
                });
            });
        });
    });
    
    document.addEventListener("DOMContentLoaded", function () {
        const tabs = document.querySelectorAll('.nav-item1');
        const tabContents = document.querySelectorAll('.tab-content');
        
        function showTab(tabId) {
            tabContents.forEach(tab => {
                tab.classList.remove('active');
            });

            const activeTab = document.getElementById(tabId);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', function () {
                const tabId = tab.id.replace('Tab', '');
                showTab(tabId);
            });
        });

        // Initially, show the Edit Profile tab
        showTab('editProfile');
    });
    function getCSRFToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
    
    function deleteTemplate(templateId) {
        if (confirm("Are you sure you want to delete this template?")) {
            fetch(`/delete-template/${templateId}/`, {
                method: "POST",
                headers: {
                    "X-CSRFToken": getCSRFToken(),
                    "Content-Type": "application/json",
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    location.reload(); // Refresh page to remove deleted template
                } else {
                    alert("Failed to delete.");
                }
            })
            .catch(error => console.error("Error deleting template:", error));
        }
    }
</script>


{% endblock %}
